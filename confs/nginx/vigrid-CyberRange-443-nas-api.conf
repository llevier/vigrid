#
# Vigrid HTTPS access for Vigrid-API (NAS)
#
server {
  listen 443 ssl default;
  server_name localhost;

  # Take fullchain here, not cert.pem
  ssl_certificate      /etc/nginx/ssl/localhost.crt;
  ssl_certificate_key  /etc/nginx/ssl/localhost.key;

  ssl_session_cache    builtin:1000 shared:SSL:1m;
  ssl_session_timeout  5m;

  ssl_protocols              TLSv1.3;
  ssl_ciphers                HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers  on;

  # hide version
  server_tokens        off;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  root   %%VIGRID_ROOT%%/www/site;

  # Vigrid home page
  location /
  {
    deny all;
    return 404;
  }

  location /manager
  {
    deny all;
    return 404;
  }

  # Vigrid API, load only
  location ~ ^/vigrid-nas-api/.*$
  {
		# CORS
		include /etc/nginx/vigrid-cors.conf;

    try_files $uri /vigrid-nas-api/vigrid-nas-api.html?order=$is_args$args;
    fastcgi_split_path_info       ^/(.+\/vigrid-nas-api)(/.+)$;
    fastcgi_pass                  unix:/run/php/php%%PHP_VER%%-fpm.sock;
    # Minimum output buffering
    fastcgi_buffers               2 4k;
    fastcgi_busy_buffers_size     4k;
    fastcgi_buffering             off;
    # fastcgi_buffer_size           8k; 
    include                       /etc/nginx/fastcgi_params;
    fastcgi_read_timeout          300;
    fastcgi_param PATH_INFO       $fastcgi_path_info;
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;
    fastcgi_param SCRIPT_FILENAME $document_root/vigrid-api/vigrid-nas-api.html?order=$1;
  }

  location ~ ^/(images|javascript|js|css|flash|media|static|font)/  {
    expires 7d;
  }

  location ~ /\.ht {
      deny  all;
  }
}
