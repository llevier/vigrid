<?php
#################################################################################################################################
#
# This material is part of VIGRID extensions to GNS3 for Trainings & CyberRange designs
#
# (c) Laurent LEVIER for script, designs and technical actions, https://github.com/llevier/
# LICENCE: Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA)
#
# Each dependancies (c) to their respective owners
#
#################################################################################################################################
  // hide notices
  ini_set('error_reporting', E_ALL & ~E_NOTICE & ~E_STRICT & ~E_DEPRECATED);
  error_reporting(E_ERROR | E_PARSE);
  
  // GNS3 functions
  include "/home/gns3/vigrid/www/site/manager/vigrid-gns3_functions.php";
  
  // turn off output buffering
  ob_implicit_flush();

  // Associated Vigrid NGinx config:
  // location /vigrid-api
  // { rewrite ^/vigrid-api/(.*)$ /manager/vigrid-api.html?order=$1 permanent; }

	if ($_GET["order"]=="") { exit; }
  
  $order=$_GET["order"];
  
  if ($order=="config")
  {
    $vigrid_config=file("/home/gns3/etc/vigrid.conf");
    if ($vigrid_config===false) { print("CANT LOAD Vigrid Configuration file"); exit; }

    // empty JSON array
    array($json_array);
    
    for ($l=0;$l<sizeof($vigrid_config);$l++)
    {
      $value="";
      $param="";

      // remove comments & useless characters
      $line=trim(preg_replace("/#.*$/","",$vigrid_config[$l]));
      
      // split in fields, since param=value, if more than 2 fields, params will be field 1, others will be values
      $f=preg_split("/=/",$line);
      $param=$f[0];
      $value=preg_replace('/"/','',preg_replace("/^$param=/","",$line));
      
      if ($param!="")
      {
        // Multiple values here
        if (($param=="VIGRID_GNS_SLAVE_HOSTS") || ($param=="VIGRID_POWER_SLAVE_HOSTS"))
        {
          $v=explode(" ",$value);
            array($json_array[$param]);
            for ($k=0;$k<sizeof($v);$k++)
            { $json_array[$param][]=$v[$k]; }
        }
        else
        { $json_array[$param]=$value; }
      }
    }
    
    echo json_encode($json_array);
    exit;
  }
  else
  { print("UNKNOWN CALL API: $order"); exit; }
?>